<!DOCTYPE html>
<html lang="en">
	<head>
		<style>
			video,
			img {
				width: 100%;
			}

			select {
				width: 250px;
				height: 30px;
				margin: 0 1em 1em 0;
			}
		</style>
	</head>

	<body>
		<div class="select">
			<label for="videoSource">Video source: </label>
			<select id="videoSource"></select>
		</div>

		<video autoplay muted></video>
		<img id="screenshot" />

		<script async>
			var videoElement = document.querySelector('video');
			var videoSelect = document.querySelector('select#videoSource');
			const img = document.querySelector('#screenshot');
			const canvas = document.createElement('canvas');

			const gotDevices = deviceInfos => {
				window.deviceInfos = deviceInfos;
				console.log('Available input and output devices:', deviceInfos);

				for (const deviceInfo of deviceInfos) {
					const option = document.createElement('option');
					option.value = deviceInfo.deviceId;

					if (deviceInfo.kind === 'videoinput') {
						var length = `Camera ${videoSelect.length + 1}`;
						option.text = deviceInfo.label || length;
						videoSelect.appendChild(option);
					}
				}
			};

			const gotStream = stream => {
				window.stream = stream;
				videoSelect.selectedIndex = [...videoSelect.options].findIndex(
					option => option.text === stream.getVideoTracks()[0].label,
				);
				videoElement.srcObject = stream;
				videoElement.playsInline = true;
			};

			const getStream = () => {
				if (window.stream)
					window.stream.getTracks().forEach(track => track.stop());

				return navigator.mediaDevices
					.getUserMedia({
						video: {
							deviceId: videoSelect.value
								? { exact: videoSelect.value }
								: undefined,
						},
					})
					.then(gotStream)
					.catch(console.log);
			};

			videoSelect.onchange = getStream;
			videoElement.onclick = () => {
				canvas.width = videoElement.videoWidth;
				canvas.height = videoElement.videoHeight;
				canvas.getContext('2d').drawImage(videoElement, 0, 0);
				img.src = canvas.toDataURL('image/jpg');
				videoElement.style.display = 'none';
			};

			img.onclick = () => {
				img.src = '';
				videoElement.style.display = 'block';
			};

			getStream()
				.then(() => navigator.mediaDevices.enumerateDevices())
				.then(gotDevices);
		</script>
		<script
			src="https://ajax.cloudflare.com/cdn-cgi/scripts/7089c43e/cloudflare-static/rocket-loader.min.js"
			data-cf-settings="a1a3bea7b4d71449458faca3-|49"
			defer=""
		></script>
	</body>
</html>
